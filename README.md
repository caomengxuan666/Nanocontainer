# NanoContainer

ä¸€ä¸ªè½»é‡çº§çš„å®¹å™¨å®ç°ï¼Œç”¨äºå­¦ä¹ å’Œç†è§£ Linux å®¹å™¨æŠ€æœ¯çš„åº•å±‚æœºåˆ¶ã€‚

## ğŸš€ ç®€ä»‹

NanoContainer æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„å®¹å™¨å¼•æ“ï¼Œå®ƒå®ç°äº†å®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬å‘½åç©ºé—´éš”ç¦»ã€cgroups èµ„æºé™åˆ¶ã€OverlayFS æ–‡ä»¶ç³»ç»Ÿå’Œç½‘ç»œç®¡ç†ã€‚è¯¥é¡¹ç›®æ—¨åœ¨æä¾›ä¸€ä¸ªæ˜“äºç†è§£çš„å®¹å™¨å®ç°ï¼Œå¸®åŠ©å¼€å‘è€…æ·±å…¥äº†è§£ Docker ç­‰å®¹å™¨æŠ€æœ¯çš„å·¥ä½œåŸç†ã€‚

## ğŸ’¾ å®‰è£…æŒ‡å—

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/example/nanocontainer.git
cd nanocontainer

# åˆ›å»ºæ„å»ºç›®å½•
mkdir build
cd build

# é…ç½®é¡¹ç›®
cmake ..

# ç¼–è¯‘
make
```

## ğŸŒŸ ç‰¹æ€§

- **å‘½åç©ºé—´éš”ç¦»**: ä½¿ç”¨ Linux å‘½åç©ºé—´å®ç°è¿›ç¨‹ã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰éš”ç¦»
- **èµ„æºé™åˆ¶**: é€šè¿‡ cgroups v2 æ§åˆ¶å®¹å™¨çš„å†…å­˜å’Œ CPU ä½¿ç”¨
- **æ–‡ä»¶ç³»ç»Ÿ**: ä½¿ç”¨ OverlayFS å®ç°è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒé•œåƒå±‚å’Œå®¹å™¨å¯å†™å±‚
- **ç½‘ç»œç®¡ç†**: æ”¯æŒå¤šç§ç½‘ç»œæ¨¡å¼ï¼ˆnoneã€bridgeï¼‰
- **é•œåƒç®¡ç†**: æ”¯æŒæ‹‰å–å’Œç®¡ç†å®¹å™¨é•œåƒ
- **å‘½ä»¤è¡Œæ¥å£**: æä¾›ç±»ä¼¼ Docker çš„å‘½ä»¤è¡Œç•Œé¢

## ğŸ—ï¸ æ„å»º

```bash
# åˆ›å»ºæ„å»ºç›®å½•
mkdir build
cd build

# é…ç½®é¡¹ç›®
cmake ..

# ç¼–è¯‘
make
```

è¦æ±‚:
- CMake 3.26+
- C++17 ç¼–è¯‘å™¨
- Linux å†…æ ¸æ”¯æŒå‘½åç©ºé—´å’Œ cgroups

## ğŸ§ª å¿«é€Ÿå¼€å§‹

### åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨

```bash
# åŸºæœ¬ç”¨æ³•
sudo ./NanoContainer run alpine:latest /bin/sh

# æŒ‡å®šç½‘ç»œæ¨¡å¼è¿è¡Œå®¹å™¨
sudo ./NanoContainer run --network bridge alpine:latest /bin/sh

# æŒ‚è½½ä¸»æœºç›®å½•åˆ°å®¹å™¨
sudo ./NanoContainer run --mount /host/path:/container/path alpine:latest /bin/sh

# è¿è¡Œå®¹å™¨å¹¶åœ¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤
sudo ./NanoContainer run --rm alpine:latest /bin/sh

# æ„å»ºå®¹å™¨é•œåƒ
sudo ./NanoContainer build -t myimage .
```

### ç®¡ç†é•œåƒ

```bash
# æ‹‰å–é•œåƒ
sudo ./NanoContainer pull alpine:latest
```

### ç®¡ç†å®¹å™¨

```bash
# åˆ—å‡ºå®¹å™¨
sudo ./NanoContainer ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
sudo ./NanoContainer log <container-id>

# åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
sudo ./NanoContainer exec <container-id> /bin/sh

# åœæ­¢å®¹å™¨
sudo ./NanoContainer stop <container-id>

# åˆ é™¤å®¹å™¨
sudo ./NanoContainer rm <container-id>
```

## ğŸ§© æ”¯æŒå‘½ä»¤

æ”¯æŒä»¥ä¸‹æ ¸å¿ƒå‘½ä»¤ï¼š

- `run`: åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨
- `build`: æ„å»ºå®¹å™¨é•œåƒ
- `ps`: åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨
- `exec`: åœ¨è¿è¡Œä¸­çš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
- `log`: æŸ¥çœ‹å®¹å™¨æ—¥å¿—
- `stop`: åœæ­¢å®¹å™¨
- `rm`: åˆ é™¤å®¹å™¨
- `pull`: æ‹‰å–å®¹å™¨é•œåƒ
- `images`: åˆ—å‡ºæœ¬åœ°é•œåƒ

## ğŸ§ª æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### å‘½åç©ºé—´éš”ç¦»

NanoContainer ä½¿ç”¨å¤šç§ Linux å‘½åç©ºé—´å®ç°éš”ç¦»ï¼š
- PID å‘½åç©ºé—´ï¼šä¸ºå®¹å™¨æä¾›ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´
- UTS å‘½åç©ºé—´ï¼šéš”ç¦»ä¸»æœºåå’ŒåŸŸå
- IPC å‘½åç©ºé—´ï¼šéš”ç¦»è¿›ç¨‹é—´é€šä¿¡èµ„æº
- MNT å‘½åç©ºé—´ï¼šéš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹
- NET å‘½åç©ºé—´ï¼šéš”ç¦»ç½‘ç»œè®¾å¤‡ã€IP åœ°å€ç­‰ç½‘ç»œèµ„æº

### Cgroups èµ„æºé™åˆ¶

é€šè¿‡ cgroups v2 å®ç°èµ„æºé™åˆ¶ï¼š
- å†…å­˜é™åˆ¶ï¼šæ§åˆ¶å®¹å™¨å¯ä»¥ä½¿ç”¨çš„å†…å­˜é‡
- CPU é™åˆ¶ï¼šæ§åˆ¶å®¹å™¨å¯ä»¥ä½¿ç”¨çš„ CPU æ—¶é—´

### OverlayFS æ–‡ä»¶ç³»ç»Ÿ

ä½¿ç”¨ OverlayFS å®ç°å®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼š
- Lower å±‚ï¼šåªè¯»é•œåƒå±‚
- Upper å±‚ï¼šå®¹å™¨å¯å†™å±‚
- Merged å±‚ï¼šåˆå¹¶è§†å›¾

## ğŸ”§ ç½‘ç»œé…ç½®

é»˜è®¤ä½¿ç”¨ bridge æ¨¡å¼ã€‚å¦‚æœéœ€è¦æ‰‹åŠ¨ç®¡ç†ç½‘ç»œæ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# æ¸…ç†æ®‹ç•™ç½‘ç»œæ¥å£
sudo ip link delete veth_host 2>/dev/null || true
sudo ip link delete veth_container 2>/dev/null || true
sudo brctl delbr nanobridge 2>/dev/null || true

# åˆ›å»ºæ–°çš„ç½‘æ¡¥
sudo brctl addbr nanobridge
sudo ip link set nanobridge up
```

æ”¯æŒçš„ç½‘ç»œæ¨¡å¼ï¼š
- `none`: å®¹å™¨æ²¡æœ‰ç½‘ç»œåŠŸèƒ½
- `bridge`: é»˜è®¤æ¨¡å¼ï¼Œé€šè¿‡ç½‘æ¡¥æä¾›ç½‘ç»œè®¿é—®

## ğŸ“š å­¦ä¹ èµ„æº

NanoContainer æ˜¯å­¦ä¹ å®¹å™¨æŠ€æœ¯çš„ç»ä½³é¡¹ç›®ï¼š
1. ä»£ç ç®€æ´ï¼Œæ ¸å¿ƒåŠŸèƒ½ä¸€ç›®äº†ç„¶
2. æ¶µç›–äº†å®¹å™¨æŠ€æœ¯çš„ä¸»è¦çŸ¥è¯†ç‚¹
3. æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œä¿®æ”¹
4. å®é™…å¯ç”¨ï¼Œä¸åªæ˜¯æ¼”ç¤ºä»£ç 
5. æä¾›è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹

## âš ï¸ æ³¨æ„äº‹é¡¹

- éœ€è¦ root æƒé™è¿è¡Œ
- ä»…æ”¯æŒ Linux ç³»ç»Ÿ
- ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿› NanoContainerï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚